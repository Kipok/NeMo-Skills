processors_to_run: all

preprocessed_dataset_files: null  # can specify multiple patters separated by space
input_files: null  # can specify datasets from HF instead of prediction_jsonl_files
output_path: ???

exclude_optional_keys: true # exclude keys other than input, output and expected_answer from the final manifest
metadata: null  # can provide additional metadata to store (e.g. dataset or generation_type)
skip_first: 0  # useful for skipping validation set from train_full generation (it's always first)
add_correct: true  # can set to False if only want to export incorrect solutions
add_incorrect: false  # if True, saves only incorrect solutions instead of correct

downsampling_method: null  # fair, random or null
random_seed: 42
do_shuffle: true
num_output_samples: null

prompt_config: llama3-instruct/math
prompt_template: llama3-instruct
chat_format: null  # null/nemotron/llama
generation_suffix: ""  # suffix to add to the end of expected response (e.g. <|eot_id|>)

input_key: question
output_key: generation

majority_filter:
  # minimum number of majority votes to use the answer
  min_majority_votes: 0
  # minimum portion of majority votes to use the answer
  min_majority_percentage: 0.

filters:
  drop_multi_boxed: true
  drop_useless_code: false
  drop_broken_code: true
  majority_filter: false
  trim_solutions: true
  code_text_filter: null


processors:
  - _target_: nemo_skills.finetuning.data_preparation_utils.preprocessing.ReadData
    preprocessed_dataset_files: ${preprocessed_dataset_files}
    input_files: ${input_files}
    input_key: ${input_key}
    output_key: ${output_key}
    skip_first: ${skip_first}
    add_correct: ${add_correct}
    add_incorrect: ${add_incorrect}

  - _target_: nemo_skills.finetuning.data_preparation_utils.filters.DropMultiBoxed
    should_run: ${filters.drop_multi_boxed}
    solution_key: ${output_key}
    test_cases:
      - {input: {generation: "He had \\boxed{3} 4090s and \\boxed{2} 4080s"}, output: null}
      - {input: {generation: "She had \\boxed{6} 4090s"}, output: {generation: "She had \\boxed{6} 4090s"}}
      - {input: {generation: "boxed boxed 42"}, output: {generation: "boxed boxed 42"}}

  - _target_: nemo_skills.finetuning.data_preparation_utils.filters.DropBrokenCode
    should_run: ${filters.drop_broken_code}
    solution_key: ${output_key}

  - _target_: nemo_skills.finetuning.data_preparation_utils.filters.MajorityFiler
    should_run: ${filters.majority_filter}
    min_majority_votes: ${majority_filter.min_majority_votes}
    min_majority_portion: ${majority_filter.min_majority_portion}
    drop_negative_answers: ${majority_filter.drop_negative_majority_answers}
    drop_noninteger_answers: ${majority_filter.drop_noninteger_majority_answers}

  - _target_: nemo_skills.finetuning.data_preparation_utils.filters.TrimSolutions
    should_run: ${filters.trim_solutions}
    solution_key: ${output_key}
    test_cases:
      - {input: {generation: "Solution ends at \\boxed{0}\nThis line is useless."}, output: {generation: "Solution ends at \\boxed{0}"}}
      - {input: {generation: "Solution continues \\boxed{7} after boxed"}, output: {generation: "Solution continues \\boxed{7} after boxed"}}

  - _target_: nemo_skills.finetuning.data_preparation_utils.preprocessing.GroupSamples
    group_key: ${input_key}

  - _target_: nemo_skills.finetuning.data_preparation_utils.filters.CodeTextFilter
    filter_type: ${filters.code_text_filter}
    solution_key: ${output_key}

  - _target_: nemo_skills.finetuning.data_preparation_utils.preprocessing.ShuffleAndDownsampleData
    num_samples: ${num_output_samples}
    sampling_method: ${downsampling_method}
    random_seed: ${random_seed}
    do_shuffle: ${do_shuffle}

  - _target_: nemo_skills.finetuning.data_preparation_utils.preprocessing.WriteFinalSftManifest
    output_manifest_file: ${output_path}
    prompt_config: ${prompt_config}
    prompt_template: ${prompt_template}
    input_key: ${input_key}
    output_key: ${output_key}
    chat_format: ${chat_format}
    generation_suffix: ${generation_suffix}
    metadata: ${metadata}
    exclude_optional_keys: ${exclude_optional_keys}
